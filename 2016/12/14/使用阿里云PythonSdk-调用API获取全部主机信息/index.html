<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 使用阿里云PythonSdk,调用API获取全部主机信息 · Messay</title><meta name="description" content="使用阿里云PythonSdk,调用API获取全部主机信息 - Messay"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://messay.me/atom.xml" title="Messay"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/lovebaicai" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">使用阿里云PythonSdk,调用API获取全部主机信息</h1><div class="post-info">Dec 14, 2016</div><div class="post-content"><h4 id="这周有个需求-需要把阿里云上的服务器信息拉下来统计-但是阿里云的文档实在是写的太烂-无奈google-工单-处理ok"><a href="#这周有个需求-需要把阿里云上的服务器信息拉下来统计-但是阿里云的文档实在是写的太烂-无奈google-工单-处理ok" class="headerlink" title="这周有个需求,需要把阿里云上的服务器信息拉下来统计.但是阿里云的文档实在是写的太烂.无奈google+工单.处理ok!"></a>这周有个需求,需要把阿里云上的服务器信息拉下来统计.但是阿里云的文档实在是写的太烂.无奈google+工单.处理ok!</h4><h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料:"></a>参考资料:</h4><ul>
<li>SDK安装和示例请参考<a href="https://develop.aliyun.com/sdk/python?spm=5176.doc25699.2.2.B3LMph" target="_blank" rel="noopener">这里</a></li>
<li>API参数请参考<a href="https://help.aliyun.com/document_detail/25484.html?spm=5176.doc25506.3.2.E7cEyj" target="_blank" rel="noopener">这里</a></li>
<li>脚本参考<a href="http://www.cnblogs.com/wangxiaoqiangs/p/5369336.html" target="_blank" rel="noopener">这里</a>,自己根据需要有删改.</li>
</ul>
<a id="more"></a>
<hr>
<h4 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法:"></a>使用方法:</h4><h4 id="第一步，需要初始化Client"><a href="#第一步，需要初始化Client" class="headerlink" title="第一步，需要初始化Client"></a>第一步，需要初始化Client</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> aliyunsdkcore <span class="keyword">import</span> client</span><br><span class="line"></span><br><span class="line">clt = client.AcsClient(<span class="string">'SFAW************'</span>,<span class="string">'Nc2nZ6dQoiqck0*************'</span>,</span><br><span class="line"><span class="string">'cn-hangzhou'</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>NOTE:DescribeInstancesRequest是调用你对应的API的模块.</p>
</blockquote>
<h4 id="第二步-初始化request。以ECS的DescribeRegionsRequest接口为例"><a href="#第二步-初始化request。以ECS的DescribeRegionsRequest接口为例" class="headerlink" title="第二步, 初始化request。以ECS的DescribeRegionsRequest接口为例:"></a>第二步, 初始化request。以ECS的DescribeRegionsRequest接口为例:</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> aliyunsdkecs.request.v20140526 <span class="keyword">import</span> DescribeInstancesRequest</span><br><span class="line"></span><br><span class="line">request = DescribeInstancesRequest.DescribeInstancesRequest()</span><br><span class="line">request.set_PageSize(Number) <span class="comment"># 设置返回sizenumber</span></span><br><span class="line">request.set_PageNumber(Number) <span class="comment"># 设置返回pagenumber</span></span><br><span class="line">request.set_accept_format(<span class="string">'json'</span>) <span class="comment"># 设置返回格式</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>NOTE:DescribeInstancesRequest是调用你对应的API的模块.除了DescribeInstancesRequest参数,其它参数都需要用set_xxx来设置.</p>
</blockquote>
<h4 id="第三步-发起API调用"><a href="#第三步-发起API调用" class="headerlink" title="第三步, 发起API调用"></a>第三步, 发起API调用</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = clt.do_action(request) <span class="comment"># 默认返回第一页,10条数据,可用set调整</span></span><br></pre></td></tr></table></figure>
<h4 id="示例脚本"><a href="#示例脚本" class="headerlink" title="示例脚本"></a>示例脚本</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">功能介绍：</span></span><br><span class="line"><span class="string">1、调用阿里云API，收集所有区域 ECS 信息</span></span><br><span class="line"><span class="string">2、将需要的数据整理、生成 Excel 文档</span></span><br><span class="line"><span class="string">3、关于阿里 sdk 的安装，api 的调用请参考阿里云官网</span></span><br><span class="line"><span class="string">4、xlsxwriter 请参考这里：http://xlsxwriter.readthedocs.org/</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json, sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> termcolor <span class="keyword">import</span> colored</span><br><span class="line">    <span class="keyword">from</span> xlsxwriter <span class="keyword">import</span> workbook</span><br><span class="line">    <span class="keyword">from</span> aliyunsdkcore <span class="keyword">import</span> client</span><br><span class="line">    <span class="keyword">from</span> aliyunsdkecs.request.v20140526 <span class="keyword">import</span> DescribeInstancesRequest</span><br><span class="line"><span class="keyword">except</span> ImportError <span class="keyword">as</span> e:</span><br><span class="line">    print(colored(<span class="string">'%s : %s'</span> % (<span class="string">'Error'</span>, e), <span class="string">'red'</span>))</span><br><span class="line">    exit(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">reload(sys)</span><br><span class="line"></span><br><span class="line">sys.setdefaultencoding(<span class="string">'utf8'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_sys_info</span><span class="params">(key, secret, zone, page)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    1、获取该区域全部主机详细信息</span></span><br><span class="line"><span class="string">    2、参数：cn-qingdao、cn-hangzhou、cn-beijing 等</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="comment"># 与阿里云建立有效连接</span></span><br><span class="line">    clt = client.AcsClient(key, secret, zone)</span><br><span class="line">    <span class="comment"># 获取该区域全部实例详细信息</span></span><br><span class="line">    request = DescribeInstancesRequest.DescribeInstancesRequest()</span><br><span class="line">    request.set_PageSize(<span class="number">100</span>)</span><br><span class="line">    request.set_PageNumber(page)</span><br><span class="line">    <span class="comment"># 将数据格式化成 json，默认为 XML</span></span><br><span class="line">    request.set_accept_format(<span class="string">'json'</span>)</span><br><span class="line">    <span class="comment"># 发起请求，获取数据</span></span><br><span class="line">    result = json.loads(clt.do_action(request)).get(<span class="string">'Instances'</span>).get(<span class="string">'Instance'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">format_data</span><span class="params">(data_info)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    从全部数据中整理出需要的数据</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    result = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> data_info:</span><br><span class="line">        data = (</span><br><span class="line">            line.get(<span class="string">'InstanceId'</span>),</span><br><span class="line">            line.get(<span class="string">'ZoneId'</span>),</span><br><span class="line">            line.get(<span class="string">'HostName'</span>),</span><br><span class="line">            line.get(<span class="string">'InstanceName'</span>),</span><br><span class="line">            line.get(<span class="string">'PublicIpAddress'</span>).get(<span class="string">'IpAddress'</span>),</span><br><span class="line">            line.get(<span class="string">'InnerIpAddress'</span>).get(<span class="string">'IpAddress'</span>),</span><br><span class="line">            line.get(<span class="string">'Cpu'</span>),</span><br><span class="line">            line.get(<span class="string">'Memory'</span>),</span><br><span class="line">            line.get(<span class="string">'InternetMaxBandwidthOut'</span>),</span><br><span class="line">            line.get(<span class="string">'Status'</span>),</span><br><span class="line">            line.get(<span class="string">'CreationTime'</span>),</span><br><span class="line">            line.get(<span class="string">'ExpiredTime'</span>)</span><br><span class="line">        )</span><br><span class="line">        result.append(data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_excel</span><span class="params">(file, data)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    1、设置 Excel 样式</span></span><br><span class="line"><span class="string">    2、将数据写入到 Excel 中</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="comment"># 生成 Excel 文件</span></span><br><span class="line">    work = workbook.Workbook(file)</span><br><span class="line">    <span class="comment"># 建立工作表，表名默认</span></span><br><span class="line">    worksheet = work.add_worksheet()</span><br><span class="line">    <span class="comment"># 设置字体加粗、字体大小</span></span><br><span class="line">    format_title = work.add_format(&#123;<span class="string">'bold'</span>: <span class="literal">True</span>, <span class="string">'font_size'</span>: <span class="number">16</span>&#125;)</span><br><span class="line">    <span class="comment"># 设置水平对齐、垂直对齐</span></span><br><span class="line">    format_title.set_align(<span class="string">'center'</span>)</span><br><span class="line">    format_title.set_align(<span class="string">'vcenter'</span>)</span><br><span class="line"></span><br><span class="line">    format_body = work.add_format(&#123;<span class="string">'font_size'</span>: <span class="number">14</span>&#125;)</span><br><span class="line">    <span class="comment"># 设置样式，行高、列宽</span></span><br><span class="line">    worksheet.set_row(<span class="number">0</span>, <span class="number">25</span>)</span><br><span class="line">    worksheet.set_column(<span class="number">0</span>, <span class="number">0</span>, <span class="number">30</span>)</span><br><span class="line">    worksheet.set_column(<span class="number">1</span>, <span class="number">1</span>, <span class="number">20</span>)</span><br><span class="line">    worksheet.set_column(<span class="number">2</span>, <span class="number">3</span>, <span class="number">28</span>)</span><br><span class="line">    worksheet.set_column(<span class="number">4</span>, <span class="number">5</span>, <span class="number">25</span>)</span><br><span class="line">    worksheet.set_column(<span class="number">6</span>, <span class="number">6</span>, <span class="number">12</span>)</span><br><span class="line">    worksheet.set_column(<span class="number">7</span>, <span class="number">9</span>, <span class="number">16</span>)</span><br><span class="line">    worksheet.set_column(<span class="number">10</span>, <span class="number">11</span>, <span class="number">25</span>)</span><br><span class="line">    <span class="comment"># 定义表头</span></span><br><span class="line">    title = (</span><br><span class="line">        <span class="string">'实例 ID'</span>,</span><br><span class="line">        <span class="string">'所在区域'</span>,</span><br><span class="line">        <span class="string">'主机名称'</span>,</span><br><span class="line">        <span class="string">'主机别名'</span>,</span><br><span class="line">        <span class="string">'公网地址'</span>,</span><br><span class="line">        <span class="string">'私网地址'</span>,</span><br><span class="line">        <span class="string">'CPU 核数'</span>,</span><br><span class="line">        <span class="string">'内存大小 MB'</span>,</span><br><span class="line">        <span class="string">'网络带宽 MB'</span>,</span><br><span class="line">        <span class="string">'运行状态'</span>,</span><br><span class="line">        <span class="string">'创建时间'</span>,</span><br><span class="line">        <span class="string">'过期时间'</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    row = <span class="number">0</span></span><br><span class="line">    col = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 表头写入文件，引用样式</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> title:</span><br><span class="line">        worksheet.write(row, col, item, format_title)</span><br><span class="line">        col += <span class="number">1</span></span><br><span class="line">    <span class="comment"># 内容写入文件，引用样式</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> data:</span><br><span class="line">        row += <span class="number">1</span></span><br><span class="line">        col = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> line:</span><br><span class="line">            worksheet.write(row, col, str(key), format_body) <span class="comment">#ip地址是list类型,需转换成str.</span></span><br><span class="line">            col += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    work.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    key = <span class="string">'key'</span></span><br><span class="line">    secret = <span class="string">'secret'</span></span><br><span class="line">    zones = [<span class="string">'cn-qingdao'</span>, <span class="string">'cn-hangzhou'</span>, <span class="string">'cn-beijing'</span>, <span class="string">'cn-shanghai] #根据需要修改</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    filename = '</span>./aliyunSystemToExcel.xlsx<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    result = []</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    for zone in zones:</span></span><br><span class="line"><span class="string">        for page in range(1, 2): # 根据主机数量,设置page数</span></span><br><span class="line"><span class="string">            info = get_sys_info(key, secret, zone, page)</span></span><br><span class="line"><span class="string">            data = format_data(info)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            [result.append(line) for line in data]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    write_excel(filename, result)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if __name__ == '</span>__main__<span class="string">':</span></span><br><span class="line"><span class="string">    main()</span></span><br></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/2016/12/20/MySQL正则表达式匹配/" class="prev">PREV</a><a href="/2016/12/12/Python获取Linux磁盘容量/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2020 <a href="http://messay.me">Messay</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>