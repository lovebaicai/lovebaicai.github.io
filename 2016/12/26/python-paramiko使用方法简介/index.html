<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> python paramiko 使用方法简介 · Messay</title><meta name="description" content="python paramiko 使用方法简介 - Messay"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://messay.me/atom.xml" title="Messay"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/lovebaicai" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">python paramiko 使用方法简介</h1><div class="post-info">Dec 26, 2016</div><div class="post-content"><h4 id="python-paramiko"><a href="#python-paramiko" class="headerlink" title="python paramiko"></a>python paramiko</h4><ul>
<li>主要介绍了python paramiko简介和使用方法，让你全面了解python的远程服务器连接和文件上传，ssh远程执行命令等</li>
<li>paramiko 遵循SSH2协议，支持以加密和认证的方式，进行远程服务器的连接，可以实现远程文件的上传，下载或通过ssh远程执行命令。</li>
<li>项目地址：<a href="https://github.com/paramiko/paramiko" target="_blank" rel="noopener">https://github.com/paramiko/paramiko</a></li>
<li>官方文档：<a href="http://docs.paramiko.org/" target="_blank" rel="noopener">http://docs.paramiko.org/</a></li>
<li>文档转载：<a href="http://www.codexiu.cn/python/blog/127/" target="_blank" rel="noopener">http://www.codexiu.cn/python/blog/127/</a> (根据自己需要有删改)</li>
</ul>
<a id="more"></a>
<h4 id="一、安装"><a href="#一、安装" class="headerlink" title="一、安装"></a>一、安装</h4><ul>
<li>root@ubuntu:~/paramiko# pip install paramiko</li>
<li>运行脚本若报错’ValueError: Multibackend cannot be initialized with no backends. If you are seeing this error when trying to use default_backend() please try uninstalling and reinstalling cryptography’.可重新安装cryptography.</li>
</ul>
<h4 id="二、上传文件到远程服务器"><a href="#二、上传文件到远程服务器" class="headerlink" title="二、上传文件到远程服务器"></a>二、上传文件到远程服务器</h4><ul>
<li>原理：通过SFTPClient类根据SSH传输协议的sftp会话，实现远程文件上传、下载等操作。实现远程文件上传、下载。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">任务：<span class="number">10.</span> <span class="number">1.101</span><span class="number">.187</span>向<span class="number">10.1</span><span class="number">.101</span><span class="number">.186</span>发送文件。</span><br><span class="line"></span><br><span class="line"><span class="number">10.1</span><span class="number">.101</span><span class="number">.187</span> 目录/root/paramiko  有三个文件 paramikosend.py  test  test.tar</span><br><span class="line"></span><br><span class="line"><span class="number">10.1</span><span class="number">.101</span><span class="number">.186</span> 目录/root/paramiko   开始为空文件夹</span><br><span class="line"></span><br><span class="line">执行python paramikosend.py,代码如下</span><br><span class="line"></span><br><span class="line">root@ubuntu:~/paramiko<span class="comment"># cat paramikosend.py</span></span><br><span class="line"><span class="keyword">import</span> paramiko,datetime,os</span><br><span class="line">hostname = <span class="string">'10.1.101.186'</span></span><br><span class="line">username = <span class="string">'root'</span></span><br><span class="line">password = <span class="string">'123456'</span></span><br><span class="line">port = <span class="number">22</span></span><br><span class="line">local_dir = <span class="string">'/root/paramiko'</span></span><br><span class="line">remote_dir = <span class="string">'/root/paramiko'</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    t=paramiko.Transport((hostname,port))</span><br><span class="line">    t.connect(username=username,password=password)</span><br><span class="line">    sftp = paramiko.SFTPClient.from_transport(t)</span><br><span class="line">    files = os.listdir(local_dir)</span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> files:</span><br><span class="line">            sftp.put(os.path.join(local_dir,f),os.path.join(remote_dir,f))</span><br><span class="line">    t.close()</span><br><span class="line"><span class="keyword">except</span> Exception:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"connect error!"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="三、从远程服务器下载文件"><a href="#三、从远程服务器下载文件" class="headerlink" title="三、从远程服务器下载文件"></a>三、从远程服务器下载文件</h4><ul>
<li>原理：通过SFTPClient类根据SSH传输协议的sftp会话，实现远程文件上传、下载等操作。实现远程文件上传、下载。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">任务：现在<span class="number">10.1</span><span class="number">.101</span><span class="number">.186</span>的/root/paramiko/temp186目录有两个文件,将其下载到<span class="number">10.1</span><span class="number">.101</span><span class="number">.187</span>的/root/paramiko/temp187目录。</span><br><span class="line"></span><br><span class="line">执行 python paramikoget.py ，代码如下:</span><br><span class="line"></span><br><span class="line">root@ubuntu:~/paramiko<span class="comment"># cat paramikoget.py</span></span><br><span class="line"><span class="keyword">import</span> paramiko,datetime,os</span><br><span class="line">hostname = <span class="string">'10.1.101.186'</span></span><br><span class="line">username = <span class="string">'root'</span></span><br><span class="line">password = <span class="string">'123456'</span></span><br><span class="line">port = <span class="number">22</span></span><br><span class="line">local_dir = <span class="string">'/root/paramiko/temp187'</span></span><br><span class="line">remote_dir = <span class="string">'/root/paramiko/temp186'</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    t=paramiko.Transport((hostname,port))</span><br><span class="line">    t.connect(username=username,password=password)</span><br><span class="line">    sftp = paramiko.SFTPClient.from_transport(t)</span><br><span class="line">    files = sftp.listdir(remote_dir) <span class="comment">#这里需要注意，列出远程文件必须使用sftp，而不能用os</span></span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> files:</span><br><span class="line">            sftp.get(os.path.join(remote_dir,f),os.path.join(local_dir,f))</span><br><span class="line">    t.close()</span><br><span class="line"><span class="keyword">except</span> Exception:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"connect error!"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="四、执行命令测试"><a href="#四、执行命令测试" class="headerlink" title="四、执行命令测试"></a>四、执行命令测试</h4><ul>
<li>原理：通过SSHClient类执行命令。SSHClient类是SSH服务会话的高级表示，封装了传输、通道以及SFTPClient的校验、建立方法，通常用于执行命令。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">任务：通过<span class="number">10.1</span><span class="number">.101</span><span class="number">.187</span>连接到<span class="number">10.1</span><span class="number">.101</span><span class="number">.186</span>，然后进入目录/root/paramiko，创建一个目录lxy。</span><br><span class="line">执行python paramikocommand.py，代码如下：</span><br><span class="line"></span><br><span class="line">root@ubuntu:~/paramiko<span class="comment"># cat paramikocommand.py</span></span><br><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line">hostname = <span class="string">'10.1.101.186'</span></span><br><span class="line">username = <span class="string">'root'</span></span><br><span class="line">password = <span class="string">'123456'</span></span><br><span class="line">port = <span class="number">22</span></span><br><span class="line">ssh = paramiko.SSHClient()</span><br><span class="line">ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span><br><span class="line">ssh.connect(hostname=hostname,port=port,username=username,password=password)</span><br><span class="line">stdin, stdout, stderr = ssh.exec_command(<span class="string">"cd  /root/paramiko;mkdir lxy"</span>)</span><br><span class="line"><span class="keyword">print</span> stdout.readlines()</span><br><span class="line">ssh.close()</span><br><span class="line"></span><br><span class="line">Note: 命令中也可以带参数：</span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line">hostname = <span class="string">'10.1.101.186'</span></span><br><span class="line">username = <span class="string">'root'</span></span><br><span class="line">password = <span class="string">'123456'</span></span><br><span class="line">port = <span class="number">22</span></span><br><span class="line">name=<span class="string">'testcmd'</span></span><br><span class="line"></span><br><span class="line">ssh = paramiko.SSHClient()</span><br><span class="line">ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span><br><span class="line">ssh.connect(hostname=hostname,port=port,username=username,password=password)</span><br><span class="line">stdin, stdout, stderr = ssh.exec_command(<span class="string">"cd  /root/paramiko;mkdir %s"</span> %name)</span><br><span class="line"><span class="keyword">print</span> stdout.readlines()</span><br><span class="line">ssh.close()</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="五、python远程执行操作的其他开源模块"><a href="#五、python远程执行操作的其他开源模块" class="headerlink" title="五、python远程执行操作的其他开源模块"></a>五、python远程执行操作的其他开源模块</h4><ul>
<li>fabric:fabric是封装了paramiko模块来实现ssh来传输文件的。</li>
<li>pexpect:也可以实现ssh 登录到某个用户指定的主机上，运行某个用户指定的命令</li>
</ul>
<h4 id="六、与输入的CMD命令进行交互"><a href="#六、与输入的CMD命令进行交互" class="headerlink" title="六、与输入的CMD命令进行交互"></a>六、与输入的CMD命令进行交互</h4><ul>
<li>stdin.write部分是用于交互情况下，通过该命令可以执行交互。注意这里可能会引起歧义，这里的交互并不是ssh连接过程中出现的让输入yes的交互，因为paramiko模块在连接过程中会自动处理好yes确认。这里的交互是指后面的cmd需要的执行的程序可能出现交互的情况下，可以通过该参数进行交互。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">代码如下:</span><br><span class="line">stdin.write(<span class="string">"Y\n"</span>)   <span class="comment">#简单交互，输入 'Y'</span></span><br><span class="line"></span><br><span class="line">使用示例:</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sshclient</span><span class="params">(ip, username, password, cmd)</span>:</span></span><br><span class="line"></span><br><span class="line">    myclient = paramiko.SSHClient()</span><br><span class="line"></span><br><span class="line">    myclient.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span><br><span class="line"></span><br><span class="line">    myclient.connect(ip, port=<span class="number">22</span>, username=username, password=password, timeout=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    stdin, stdout, stderr = myclient.exec_command(cmd)</span><br><span class="line"></span><br><span class="line">    stdin.write(<span class="string">"y\n"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> stdout.readlines()</span><br><span class="line"></span><br><span class="line">    myclient.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(str(sys.argv[<span class="number">1</span>])) &lt;= <span class="number">14</span>:</span><br><span class="line">    cmd = <span class="string">'cd /test &amp;&amp; python3 upload.py -f %s '</span> % sys.argv[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    cmd = <span class="string">'cd /test &amp;&amp; python3 upload_by_id.py -f %s'</span> % sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">sshclient(<span class="string">'hostname'</span>, <span class="string">'username'</span>, <span class="string">'password'</span>, cmd=cmd)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2017/02/06/Mysql-批量删除相同前缀的表/" class="prev">PREV</a><a href="/2016/12/21/Python-发送邮件报错Name-or-service-not-known/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2020 <a href="http://messay.me">Messay</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>