<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Prometheus联邦集群+Alertmanager电话报警配置示例说明 · Messay</title><meta name="description" content="Prometheus联邦集群+Alertmanager电话报警配置示例说明 - Messay"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://messay.me/atom.xml" title="Messay"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/lovebaicai" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Prometheus联邦集群+Alertmanager电话报警配置示例说明</h1><div class="post-info">Aug 30, 2019</div><div class="post-content"><h4 id="目前公司有两个业务线，所以搭建了两套Kubernetes集群用来部署不同业务，每套集群内部都是用容器部署了一套Prometheus监控自身的业务。基于数据易于分析和预警及时的考虑，故整合两个集群的Prometheus数据到外层的一个Prometheus里，并增加高级别异常电话告警。联邦集群的原理这里不在赘述，各组件具体配置示例如下："><a href="#目前公司有两个业务线，所以搭建了两套Kubernetes集群用来部署不同业务，每套集群内部都是用容器部署了一套Prometheus监控自身的业务。基于数据易于分析和预警及时的考虑，故整合两个集群的Prometheus数据到外层的一个Prometheus里，并增加高级别异常电话告警。联邦集群的原理这里不在赘述，各组件具体配置示例如下：" class="headerlink" title="目前公司有两个业务线，所以搭建了两套Kubernetes集群用来部署不同业务，每套集群内部都是用容器部署了一套Prometheus监控自身的业务。基于数据易于分析和预警及时的考虑，故整合两个集群的Prometheus数据到外层的一个Prometheus里，并增加高级别异常电话告警。联邦集群的原理这里不在赘述，各组件具体配置示例如下："></a>目前公司有两个业务线，所以搭建了两套<code>Kubernetes</code>集群用来部署不同业务，每套集群内部都是用容器部署了一套<code>Prometheus</code>监控自身的业务。基于数据易于分析和预警及时的考虑，故整合两个集群的<code>Prometheus</code>数据到外层的一个<code>Prometheus</code>里，并增加高级别异常电话告警。联邦集群的原理这里不在赘述，各组件具体配置示例如下：</h4><a id="more"></a>
<h4 id="一、外层聚合Prometheus-二进制形式-配置示例"><a href="#一、外层聚合Prometheus-二进制形式-配置示例" class="headerlink" title="一、外层聚合Prometheus(二进制形式)配置示例:"></a>一、外层聚合<code>Prometheus</code>(二进制形式)配置示例:</h4><ul>
<li><code>Prometheus</code>配置示例</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"># file: prometheus.yml</span><br><span class="line"></span><br><span class="line"># my global config</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line"></span><br><span class="line"># Alertmanager configuration</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets: [&quot;localhost:9093&quot;]</span><br><span class="line"></span><br><span class="line"># Load rules once and periodically evaluate them according to the global &apos;evaluation_interval&apos;.</span><br><span class="line">rule_files:                               # 相关rule此处请根据需要自行配置</span><br><span class="line">  - &quot;/opt/prometheus/rules/*.rules&quot;</span><br><span class="line">  - &quot;/opt/prometheus/rules/*.yaml&quot;</span><br><span class="line"></span><br><span class="line"># A scrape configuration containing exactly one endpoint to scrape:</span><br><span class="line"># Here it&apos;s Prometheus itself.</span><br><span class="line">scrape_configs:</span><br><span class="line"></span><br><span class="line">  #   static_configs:</span><br><span class="line">  #   - targets: [&apos;localhost:9090&apos;]</span><br><span class="line">  - job_name: &apos;federate&apos;</span><br><span class="line">  #  scrape_interval: 15s</span><br><span class="line"></span><br><span class="line">    honor_labels: true</span><br><span class="line">    metrics_path: &apos;/federate&apos;</span><br><span class="line"></span><br><span class="line">    params:                               # 此处注意，job需要和收集端的job名称一致</span><br><span class="line">      &apos;match[]&apos;:</span><br><span class="line">        - &apos;&#123;job=&quot;prometheus&quot;&#125;&apos;    </span><br><span class="line">        - &apos;&#123;job=&quot;etcd&quot;&#125;&apos;</span><br><span class="line">        - &apos;&#123;job=~&quot;kubernetes-.*&quot;&#125;&apos;</span><br><span class="line">        - &apos;&#123;job=~&quot;kube-.*&quot;&#125;&apos;</span><br><span class="line">        # - &apos;&#123;job=~&quot;kubelet.*&quot;&#125;&apos;</span><br><span class="line"></span><br><span class="line">    static_configs:                      # 需收集的地址 </span><br><span class="line">      - targets:</span><br><span class="line">        - &apos;192.168.7.74:9090&apos;</span><br><span class="line">        - &apos;192.168.7.47:9090&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># file: prometheus.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Prometheus</span><br><span class="line">Documentation=https://prometheus.io/</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/opt/prometheus/prometheus \</span><br><span class="line">  --config.file=/opt/prometheus/prometheus.yml \    </span><br><span class="line">  --storage.tsdb.path=/opt/prometheus/data \     </span><br><span class="line">  --storage.tsdb.retention=168h \             # 数据持久化时间</span><br><span class="line">  --web.enable-lifecycle                      # 启用配置热更新</span><br><span class="line"> </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<ul>
<li><code>alertmanager</code>配置示例</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># file: alertmanager.yml</span><br><span class="line"></span><br><span class="line">global:</span><br><span class="line">  smtp_smarthost: &quot;smtp.server.org:25&quot;</span><br><span class="line">  smtp_from: &quot;k8salert@server.org&quot;</span><br><span class="line">  smtp_auth_username: &quot;k8salert@server.org&quot;</span><br><span class="line">  smtp_auth_password: &quot;password&quot;</span><br><span class="line">  smtp_require_tls: false</span><br><span class="line">templates:</span><br><span class="line">  - &apos;/opt/alertmanager/templates/*.tmpl&apos;                     </span><br><span class="line">route:</span><br><span class="line">  receiver: &apos;email_alert&apos;</span><br><span class="line">  group_by: [&apos;alertname&apos;, &apos;instance&apos;, &apos;service&apos;, &apos;severity&apos;] # 聚合报警类别</span><br><span class="line">  group_wait: 10s                                            # 聚合等待时间,超过这个时间开始发送报警</span><br><span class="line">  group_interval: 3m                                         # 已经存在的group等待group_interval这个时间段看报警问题是否解决</span><br><span class="line">  repeat_interval: 5m                                        # 再次报警间隔</span><br><span class="line">  routes:</span><br><span class="line">  - match:                                                   # 报警媒介匹配规则</span><br><span class="line">      severity: critical                                     # 匹配label</span><br><span class="line">    receiver: &apos;multi_alert&apos;</span><br><span class="line">receivers:                                                   # 报警发送媒介</span><br><span class="line">  - name: &apos;email_alert&apos;                                      # email</span><br><span class="line">    email_configs:</span><br><span class="line">    - to: &apos;aaa@server.com&apos;</span><br><span class="line">      send_resolved: true</span><br><span class="line">  - name: &apos;multi_alert&apos;                                      # 多重媒介</span><br><span class="line">    webhook_configs:</span><br><span class="line">    - send_resolved: true                                    # 电话报警</span><br><span class="line">      url: &apos;http://192.168.7.105:8765/phoneWarn/callUp/v1/prome&apos;</span><br><span class="line">    email_configs:                                           # email</span><br><span class="line">    - to: &apos;aaa@server.com&apos;</span><br><span class="line">      send_resolved: true</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line"># file: alertmanager.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Prometheus Alertmanager Service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/opt/alertmanager/alertmanager \</span><br><span class="line">    --config.file /opt/alertmanager/alertmanager.yml \</span><br><span class="line">    --storage.path /opt/alertmanager/data</span><br><span class="line">Restart=always</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<h4 id="二、电话报警配置说明示例"><a href="#二、电话报警配置说明示例" class="headerlink" title="二、电话报警配置说明示例"></a>二、电话报警配置说明示例</h4><ul>
<li>电话报警原理：电话报警其实就是把<code>prometheus</code>发送给<code>alertmanager</code>的报警信息重新封装，推给已有的电话报警接口里(此处我们公司用的是封装的阿里云的电话接口)</li>
<li><code>prometheus</code>发送原始信息示例(需二次封装)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;status&quot;: &quot;firing&quot;,</span><br><span class="line">    &quot;groupLabels&quot;: &#123;</span><br><span class="line">        &quot;alertname&quot;: &quot;pod_container_restart&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;groupKey&quot;: &quot;&#123;&#125;:&#123;alertname=\&quot;pod_container_restart\&quot;&#125;&quot;,</span><br><span class="line">    &quot;commonAnnotations&quot;: &#123;</span><br><span class="line">        &quot;description&quot;: &quot;Pod coredns-6fc7b84544-58ff6 in namespace kube-system has a container resstart for more than 5 times&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;alerts&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;status&quot;: &quot;firing&quot;,</span><br><span class="line">            &quot;labels&quot;: &#123;</span><br><span class="line">                &quot;k8s_app&quot;: &quot;kube-state-metrics&quot;,</span><br><span class="line">                &quot;container&quot;: &quot;coredns&quot;,</span><br><span class="line">                &quot;severity&quot;: &quot;Warning&quot;,</span><br><span class="line">                &quot;kubernetes_namespace&quot;: &quot;kube-system&quot;,</span><br><span class="line">                &quot;namespace&quot;: &quot;kube-system&quot;,</span><br><span class="line">                &quot;instance&quot;: &quot;192.168.171.25:8080&quot;,</span><br><span class="line">                &quot;job&quot;: &quot;kube-state-metrics&quot;,</span><br><span class="line">                &quot;alertname&quot;: &quot;pod_container_restart&quot;,</span><br><span class="line">                &quot;pod&quot;: &quot;coredns-6fc7b84544-58ff6&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;endsAt&quot;: &quot;0001-01-01T00:00:00Z&quot;,</span><br><span class="line">            &quot;generatorURL&quot;: &quot;http://k8s-master-71:9090/graph?g0.expr=kube_pod_container_status_restarts_total+%3E+5&amp;g0.tab=1&quot;,</span><br><span class="line">            &quot;startsAt&quot;: &quot;2019-08-27T19:22:54.730949237+08:00&quot;,</span><br><span class="line">            &quot;annotations&quot;: &#123;</span><br><span class="line">                &quot;description&quot;: &quot;Pod coredns-6fc7b84544-58ff6 in namespace kube-system has a container resstart for more than 5 times&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;version&quot;: &quot;4&quot;,</span><br><span class="line">    &quot;receiver&quot;: &quot;phone_alert&quot;,</span><br><span class="line">    &quot;externalURL&quot;: &quot;http://k8s-master-71:9093&quot;,</span><br><span class="line">    &quot;commonLabels&quot;: &#123;</span><br><span class="line">        &quot;k8s_app&quot;: &quot;kube-state-metrics&quot;,</span><br><span class="line">        &quot;container&quot;: &quot;coredns&quot;,</span><br><span class="line">        &quot;severity&quot;: &quot;Warning&quot;,</span><br><span class="line">        &quot;kubernetes_namespace&quot;: &quot;kube-system&quot;,</span><br><span class="line">        &quot;namespace&quot;: &quot;kube-system&quot;,</span><br><span class="line">        &quot;instance&quot;: &quot;192.168.171.25:8080&quot;,</span><br><span class="line">        &quot;job&quot;: &quot;kube-state-metrics&quot;,</span><br><span class="line">        &quot;alertname&quot;: &quot;pod_container_restart&quot;,</span><br><span class="line">        &quot;pod&quot;: &quot;coredns-6fc7b84544-58ff6&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>电话报警功能封装代码示例：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># url: http://192.168.7.105:8765/phoneWarn/callUp/v1/prome</span><br><span class="line"></span><br><span class="line">@app.route(api_prefix+&apos;prome&apos;, methods=[&apos;POST&apos;])</span><br><span class="line">def prome_alert():</span><br><span class="line">    content_name = &quot;您好&quot;</span><br><span class="line">    phonenums = [&quot;131xxxxxxxx&quot;,&quot;141xxxxxxxx&quot;]</span><br><span class="line">    alert_info = json.loads(request.data)</span><br><span class="line">    call_content = &quot;容器集群&quot; + alert_info[&apos;groupLabels&apos;][&apos;alertname&apos;]</span><br><span class="line">    alert_status = alert_info[&apos;status&apos;]</span><br><span class="line">    if alert_status == &quot;firing&quot;:</span><br><span class="line">        for phonenum in phonenums:</span><br><span class="line">            params = &#123;&quot;taskname&quot;:&quot;&#123;&#125;&quot;.format(call_content), &quot;name&quot;:&quot;&#123;&#125;&quot;.format(content_name),</span><br><span class="line">                      &quot;phonenum&quot;: &quot;&#123;&#125;&quot;.format(phonenum)&#125;</span><br><span class="line">            result = call_method.tts_call(phonenum, json.dumps(params))   # 自己封装的阿里云接口</span><br><span class="line">    elif alert_status == &quot;resolved&quot;:</span><br><span class="line">        params = &#123;&quot;result&quot;: &quot;恢复不电话报警..&quot;&#125;</span><br><span class="line">    logger.info(json.dumps(params, ensure_ascii=False))</span><br><span class="line">    return jsonify(json.loads(result))</span><br></pre></td></tr></table></figure>
<h4 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h4><ul>
<li><a href="https://www.li-rui.top/2018/11/12/monitor/Prometheus%20Alertmanager%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">Prometheus Alertmanager使用</a></li>
<li><a href="https://yunlzheng.gitbook.io/prometheus-book/" target="_blank" rel="noopener">prometheus-book</a></li>
<li><a href="https://prometheus.io/docs/prometheus/latest/getting_started/" target="_blank" rel="noopener">prometheus document</a></li>
<li><a href="https://theo.im/blog/2017/10/16/release-prometheus-alertmanager-webhook-for-dingtalk/" target="_blank" rel="noopener">将钉钉接入 Prometheus AlertManager WebHook</a></li>
<li><a href="https://www.cnblogs.com/longcnblogs/p/9620733.html" target="_blank" rel="noopener">Prometheus 和 Alertmanager实战配置</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2020/05/25/Macbook-pro-2015升级硬盘-开机黑屏故障处理/" class="prev">上一篇</a><a href="/2019/08/20/使用log-pilot收集ingress日志/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2020 <a href="http://messay.me">Messay</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>