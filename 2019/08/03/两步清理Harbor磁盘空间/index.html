<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 两步清理Harbor磁盘空间 · Messay</title><meta name="description" content="两步清理Harbor磁盘空间 - Messay"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://messay.me/atom.xml" title="Messay"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/lovebaicai" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">两步清理Harbor磁盘空间</h1><div class="post-info">Aug 3, 2019</div><div class="post-content"><h4 id="测试环境的Harbor磁盘已经不堪重负-一天不知道多少个迭代测试包丢上面，清理已经刻不容缓。因公司使用Harbor版本比较老，无法在线清理，故需要两步清理：先删除不需要的tag，然后在使用garbage-collection-GC-回收磁盘空间。"><a href="#测试环境的Harbor磁盘已经不堪重负-一天不知道多少个迭代测试包丢上面，清理已经刻不容缓。因公司使用Harbor版本比较老，无法在线清理，故需要两步清理：先删除不需要的tag，然后在使用garbage-collection-GC-回收磁盘空间。" class="headerlink" title="测试环境的Harbor磁盘已经不堪重负,一天不知道多少个迭代测试包丢上面，清理已经刻不容缓。因公司使用Harbor版本比较老，无法在线清理，故需要两步清理：先删除不需要的tag，然后在使用garbage collection(GC)回收磁盘空间。"></a>测试环境的Harbor磁盘已经不堪重负,一天不知道多少个迭代测试包丢上面，清理已经刻不容缓。因公司使用Harbor版本比较老，无法在线清理，故需要两步清理：先删除不需要的tag，然后在使用garbage collection(GC)回收磁盘空间。</h4><div class="tip">Harbor已经在1.7.0版本支持在线清理空间.</div>

<a id="more"></a>
<h4 id="一、清理不需要的镜像tag"><a href="#一、清理不需要的镜像tag" class="headerlink" title="一、清理不需要的镜像tag"></a>一、清理不需要的镜像tag</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">#! /usr/bin/env python3</span><br><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line"># 此脚本基于时间排序，仅保留最新的15个tag</span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line">requests.packages.urllib3.disable_warnings()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class CleanHarbor:</span><br><span class="line">    def __init__(self, user, password):</span><br><span class="line">        self.user = user</span><br><span class="line">        self.password = password</span><br><span class="line">        self.base_url = &quot;https://registry.youdomain.com/&quot;</span><br><span class="line">        self.login_url = self.base_url + &apos;login&apos;</span><br><span class="line">        self.project_url = self.base_url + &apos;api/projects&apos;</span><br><span class="line">        self.repo_url = self.base_url + &apos;api/repositories&apos;</span><br><span class="line">        self.session = requests.Session()</span><br><span class="line">        self.session.verify = False</span><br><span class="line">        # 此处是个坑,harbor源码auth部分的username是principal,故params参数必须是principal,否则会401</span><br><span class="line">        self.session.post(self.login_url, params=&#123;&quot;principal&quot;: self.user, &quot;password&quot;: self.password&#125;)</span><br><span class="line"></span><br><span class="line">    def get_project(self):</span><br><span class="line">        project_info = []</span><br><span class="line">        harbor_info = self.session.get(self.project_url).json()</span><br><span class="line">        for project in harbor_info:</span><br><span class="line">            info = &#123;&#125;</span><br><span class="line">            info[&apos;project_id&apos;] = project[&apos;project_id&apos;]</span><br><span class="line">            info[&apos;project_name&apos;] = project[&apos;name&apos;]</span><br><span class="line">            project_info.append(info)</span><br><span class="line">        return project_info</span><br><span class="line"></span><br><span class="line">    def get_delete_repo(self):</span><br><span class="line">        project_info = self.get_project()</span><br><span class="line">        delete_reponame = []</span><br><span class="line">        for project_id in project_info:</span><br><span class="line">            repo_info = self.session.get(self.repo_url, params=&#123;&quot;project_id&quot;: project_id[&apos;project_id&apos;]&#125;).json()</span><br><span class="line">            for repo in repo_info:</span><br><span class="line">                if repo[&apos;tags_count&apos;] &gt; 15:</span><br><span class="line">                    delete_reponame.append(repo[&apos;name&apos;])</span><br><span class="line">        return delete_reponame</span><br><span class="line"></span><br><span class="line">    def delete_repo_tag(self):</span><br><span class="line">        delete_reponame = self.get_delete_repo()</span><br><span class="line">        for repo_name in delete_reponame:</span><br><span class="line">            tag_url = self.repo_url + &quot;/&quot; + repo_name + &quot;/tags&quot;</span><br><span class="line">            tags = self.session.get(tag_url).json()</span><br><span class="line">            tags_sort = sorted(tags, key=lambda tags: tags[&quot;created&quot;])</span><br><span class="line">            del_tags = tags_sort[0:len(tags_sort) - 15]</span><br><span class="line">            for tag in del_tags:</span><br><span class="line">                del_repo_tag_url = tag_url + &quot;/&quot; + tag[&apos;name&apos;]</span><br><span class="line">                result = self.session.delete(del_repo_tag_url)</span><br><span class="line">                if result.status_code == 200:</span><br><span class="line">                    print(&apos;&#123;&#125;:&#123;&#125; tag删除成功..&apos;.format(repo_name, tag[&apos;name&apos;]))</span><br><span class="line">        print(&quot;所有tag删除完成...&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    Harobr = CleanHarbor(&apos;admin&apos;, &apos;Harbor12345&apos;)</span><br><span class="line">    Harobr.delete_repo_tag()</span><br></pre></td></tr></table></figure>
<h4 id="二、使用garbage-collection-GC-机制删除镜像的实际文件"><a href="#二、使用garbage-collection-GC-机制删除镜像的实际文件" class="headerlink" title="二、使用garbage collection(GC)机制删除镜像的实际文件"></a>二、使用garbage collection(GC)机制删除镜像的实际文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 先停止harbor服务</span><br><span class="line">docker-compose down</span><br><span class="line"></span><br><span class="line"># 使用gc回收磁盘空间(GC使用“标记-清理”法)</span><br><span class="line"># 第一步，标记:registry扫描元数据，元数据能够索引到的blob标记为不能删除</span><br><span class="line"># 第二步，清理:registry扫描所有blobs，如果该blob没有被标记，则删除它</span><br><span class="line"># 注意此处的registry-photon,请保持和你的版本一致,如下图</span><br><span class="line">image_name=$(docker ps | grep registry | grep photon | awk -F &quot; &quot; &apos;&#123;print $2&#125;&apos;)</span><br><span class="line">docker run -it --name gc --rm --volumes-from registry $&#123;image_name&#125; garbage-collect  /etc/registry/config.yml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 启动Harbor</span><br><span class="line">docker-compose start</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2019/08/03/7haTXbVHmujp8rD.jpg" alt></p>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考:"></a>参考:</h4><ul>
<li><a href="https://www.cnblogs.com/breezey/p/10615231.html" target="_blank" rel="noopener">tag清理脚本</a></li>
<li><a href="https://ieevee.com/tech/2017/12/28/docker-registry-gc.html" target="_blank" rel="noopener">gc回收步骤</a></li>
<li><a href="https://github.com/goharbor/harbor/blob/master/docs/user_guide.md#deleting-repositories" target="_blank" rel="noopener">harbor user guide</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2019/08/03/为Kubernetes集群内的Pod配置NFS存储/" class="prev">上一篇</a><a href="/2019/07/27/mega网盘命令行模式使用说明/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2020 <a href="http://messay.me">Messay</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>