<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 搭建DNS管理平台的一些注意要点 · Messay</title><meta name="description" content="搭建DNS管理平台的一些注意要点 - Messay"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://messay.me/atom.xml" title="Messay"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/lovebaicai" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">搭建DNS管理平台的一些注意要点</h1><div class="post-info">Jul 20, 2019</div><div class="post-content"><h4 id="公司内部一直缺少一个管理DNS的平台，故搭建了一个WEB页面，用来管理内部的DNS解析。期间遇到的一些坑，分享一下。"><a href="#公司内部一直缺少一个管理DNS的平台，故搭建了一个WEB页面，用来管理内部的DNS解析。期间遇到的一些坑，分享一下。" class="headerlink" title="公司内部一直缺少一个管理DNS的平台，故搭建了一个WEB页面，用来管理内部的DNS解析。期间遇到的一些坑，分享一下。"></a>公司内部一直缺少一个管理DNS的平台，故搭建了一个WEB页面，用来管理内部的DNS解析。期间遇到的一些坑，分享一下。</h4><h4 id="一、BIND-DNS主从模式选择"><a href="#一、BIND-DNS主从模式选择" class="headerlink" title="一、BIND-DNS主从模式选择"></a>一、BIND-DNS主从模式选择</h4><ul>
<li>如果使用web页面来管理DNS，其实BIND-DNS最方便的是主和从都采用数据库作为后端数据存储。主DNS使用主数据库，然后从DNS使用从数据库。然后web页面修改了主数据库后，那么从数据库也会实时同步更新。达到DNS主从同步的目的；</li>
<li>采用以上方法虽然简单，但是一个致命的问题。就是如果使用数据库作为DNS的后端存储，那么DNS的解析速度是远远不如使用文件作为后端数据存储的(对比下图)；</li>
<li>综上，故建议主DNS使用数据库存储，然后web页面管理主DNS。而从DNS使用文件存储，每次修改主DNS数据库，自动同步数据到从DNS的文件上，所有的主机使用从DNS作为DNS服务器，达到管理方便和解析快速的双重目的；<a id="more"></a></li>
<li>一张解析速度对比图：</li>
</ul>
<p><img src="https://i.loli.net/2019/07/17/5d2effe7abfda66317.png" alt></p>
<h4 id="二、DNS主从同步实时处理"><a href="#二、DNS主从同步实时处理" class="headerlink" title="二、DNS主从同步实时处理"></a>二、DNS主从同步实时处理</h4><ul>
<li>一般来说，DNS主从同时使用相同模式，基本不存在数据不同步的问题。但是如果主从使用不同模式部署，就会出现数据不同步的异常；</li>
<li>采用不同模式，在主DNS修改了数据之后，从DNS是根据设定的refresh值来同步的。如果解析可接受延迟，那么可把refresh值修改的短一点，实现主从同步；</li>
<li>如果接受不了延迟，那么可使用rndc命令手动强制刷新，在修改了主DNS的数据后，强制同步从DNS，示例代码如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 手动强制refresh记录，不等300s</span><br><span class="line">def record_refresh(domain_name):</span><br><span class="line">    DNS_slave_ip = settings.DNS_SLAVE_IP</span><br><span class="line">    result_code = []</span><br><span class="line">    for slave_ip in DNS_slave_ip:</span><br><span class="line">        command = &apos;rndc -s &#123;&#125; -p 953 -k rndc.key refresh &quot;&#123;&#125;&quot;&apos;.format(slave_ip, domain_name)</span><br><span class="line">        result_code.append(subprocess.call(command, shell=True))</span><br><span class="line">    for i in range(len(result_code)):</span><br><span class="line">        if result_code[i] != 0:</span><br><span class="line">            return False</span><br><span class="line">    print(&apos;refresh success..&apos;)</span><br></pre></td></tr></table></figure>
<h4 id="三、serial导致的不同步"><a href="#三、serial导致的不同步" class="headerlink" title="三、serial导致的不同步"></a>三、<code>serial</code>导致的不同步</h4><ul>
<li><code>serial</code>是SOA默认参数，这个参数非常重要，当从DNS需要<code>refresh</code>解析的时候，会先去查下<code>serial</code>的值是否改变(增加)，若<code>serial</code>有增加，则会<code>refresh</code>当前从DNS的解析记录，反之则不进行任何变动；</li>
<li>当你在web页面编辑DNS解析的时候，不管是增加、删除，或者修改，都需要变动<code>serial</code>的值，每变动一次都需要将数值其增加；</li>
</ul>
<h4 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h4><ul>
<li>速度对比图：<a href="http://bind-dlz.sourceforge.net/perf_tests.html" target="_blank" rel="noopener">http://bind-dlz.sourceforge.net/perf_tests.html</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2019/07/27/mega网盘命令行模式使用说明/" class="prev">PREV</a><a href="/2019/07/16/Centos6-10-安装Docker-17-03-2-ce/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2021 <a href="http://messay.me">Messay</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>